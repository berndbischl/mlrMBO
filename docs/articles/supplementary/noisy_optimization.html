<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Noisy Optimization • mlrMBO</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Noisy Optimization">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">mlrMBO</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/mlrMBO.html">
    <span class="fa fa-bolt"></span>
     
    Quickstart
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-text-o"></span>
     
    Topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/supplementary/mixed_space_optimization.html">Mixed Space Optimization</a>
    </li>
    <li>
      <a href="../../articles/supplementary/parallelization.html">Parallelization</a>
    </li>
    <li>
      <a href="../../articles/supplementary/noisy_optimization.html">Noisy Optimization</a>
    </li>
    <li>
      <a href="../../articles/supplementary/infill_criteria.html">Infill Criteria</a>
    </li>
    <li>
      <a href="../../articles/supplementary/machine_learning_with_mlrmbo.html">Machine learning with mlrMBO</a>
    </li>
    <li>
      <a href="../../articles/supplementary/human_in_the_loop_MBO.html">Human-in-the-loop MBO</a>
    </li>
    <li>
      <a href="../../articles/supplementary/mlrmbo_and_the_command_line.html">mlrMBO and the Command Line</a>
    </li>
    <li>
      <a href="../../articles/supplementary/adaptive_infill_criteria.html">Adaptive Infill Criteria</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">
    <span class="fa fa-book"></span>
     
    Reference
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mlr-org/mlrMBO">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Noisy Optimization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mlrMBO/blob/master/vignettes/supplementary/noisy_optimization.Rmd"><code>vignettes/supplementary/noisy_optimization.Rmd</code></a></small>
      <div class="hidden name"><code>noisy_optimization.Rmd</code></div>

    </div>

    
    
<div id="purpose" class="section level2">
<h2 class="hasAnchor">
<a href="#purpose" class="anchor"></a>Purpose</h2>
<p>This vignette will give you a short overview about techniques in <strong>mlrMBO</strong> to handle optimization of noisy objective functions.</p>
<p>You can also try to reduce noise by using parallel evaluations of the same setting as explained in the Vignette about parallelization.</p>
</div>
<div id="infill-criteria-for-noisy-optimization" class="section level2">
<h2 class="hasAnchor">
<a href="#infill-criteria-for-noisy-optimization" class="anchor"></a>Infill criteria for noisy optimization</h2>
<p>Like always let’s start with the function we want to optimize, but this time it will be noisy. Note that Kriging requires homoscedasticity but slight dependencies of the variance on the <span class="math inline">\(\boldsymbol{x}\)</span> can be acceptable like in the following example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(mlrMBO)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">fun =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, <span class="dt">mean =</span> x<span class="op">^</span><span class="dv">2</span>, <span class="dt">sd =</span> <span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span><span class="op">*</span>(x<span class="op">+</span><span class="dv">5</span>))</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">obj.fun =<span class="st"> </span><span class="kw">makeSingleObjectiveFunction</span>(<span class="dt">name =</span> <span class="st">"noisy_parable"</span>, <span class="dt">fn =</span> fun, <span class="dt">has.simple.signature =</span> <span class="ot">TRUE</span>, <span class="dt">par.set =</span> <span class="kw">makeNumericParamSet</span>(<span class="st">"x"</span>, <span class="dv">1</span>, <span class="dv">-5</span>, <span class="dv">5</span>), <span class="dt">noisy =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co"># visualize the function</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(obj.fun, <span class="dt">length.out =</span> <span class="dv">200</span>)</a></code></pre></div>
<p><img src="noisy_optimization_files/figure-html/objective_function-1.png" width="700"></p>
<p>As you can see the function is more noisy for large values of <span class="math inline">\(\boldsymbol{x}\)</span> so that the true optimum at <code>x=0</code> appears to be hidden. It is important to consider the way the final solution is generated (<code>final.method</code>). By default the best observed <span class="math inline">\(y\)</span> value and its corresponding <span class="math inline">\(\boldsymbol{x}\)</span>-values are returned as the optimal solution but in the case of noisy optimization the lowest observed <span class="math inline">\(y\)</span> value can just be the result of noise. Preferably the <em>best predicted</em> value of <span class="math inline">\(y\)</span> is taken as the prediction of the surrogate reflects the mean and is less affected by the noise.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/makeMBOControl.html">makeMBOControl</a></span>(<span class="dt">final.method =</span> <span class="st">"best.predicted"</span>, <span class="dt">final.evals =</span> <span class="dv">10</span>)</a></code></pre></div>
<p>For noisy optimization we there are two <em>infill criteria</em> that are recommended:</p>
<ul>
<li>
<code>aei</code>: In contrast to the <em>Expected Improvement</em> the <strong>Augmented Expected Improvement</strong> does not look at the best observed value for reference but at the effective best solution: <span class="math display">\[y^{\ast}_{\min} := \min\limits_{\boldsymbol{x} \in \{\boldsymbol{x}^{(1)}, \ldots, \boldsymbol{x}^{(j)}\}} \hat{\mu}(\boldsymbol{x}) - \hat{s}(\boldsymbol{x})\]</span> The final acquisition function is then similar to the <em>Expected Improvement</em> except from an additional factor that takes the nugget effect <span class="math inline">\(\sigma_{\epsilon}\)</span> into account (<em>Note</em>: Only supported for <em>DiceKriging</em>, for other surrogates <span class="math inline">\(\sigma_{\epsilon}\)</span> will be estimated by the square root of the residuals variance.): <span class="math display">\[\operatorname{AEI}(\boldsymbol{x}) = \left( y^{\ast}_{\min} - \hat{\mu}(\boldsymbol{x}) \right) \Phi \left( \frac{y^{\ast}_{\min} - \hat{\mu}(\boldsymbol{x}))}{\hat{s}(\boldsymbol{x})} \right) + \hat{s}(\boldsymbol{x}) \phi \left( \frac{y^{\ast}_{\min} - \hat{\mu}(\boldsymbol{x})}{\hat{s}(\boldsymbol{x})} \right) \cdot \left(1 - \frac{\sigma_{\epsilon}}{\sqrt{\sigma_{\epsilon}^2 + \hat{s}^2(\boldsymbol{x})}} \right)\]</span>
</li>
<li>
<code>eqi</code>: The <strong>Expected Quantile Improvement</strong> similarly to the <em>Augmented Expected Improvement</em> does not use an actual observed <span class="math inline">\(y\)</span> value as reference but the posterior distribution to calculate the <span class="math inline">\(\beta\)</span> quantile <span class="math inline">\(q\)</span> at already evaluated points <span class="math inline">\(\boldsymbol{x}\)</span>. The value <span class="math inline">\(\beta\)</span> can be supplied by the user calling i.e. <code><a href="../../reference/infillcrits.html">makeMBOInfillCritEQI(eqi.beta = 0.9)</a></code>. <span class="math display">\[\operatorname{EQI}(\boldsymbol{x}) &amp;= \left(q_{\min} - q(\boldsymbol{x}) \right) \Phi \left( \frac{q_{\min} - q(\boldsymbol{x})}{s_{q(\boldsymbol{x})}} \right) + s_{q(\boldsymbol{x})} \phi \left( \frac{ q_{\min} - q(\boldsymbol{x})}{s_{q(\boldsymbol{x})}} \right)\]</span>
</li>
</ul>
<div id="example-expected-quantile-improvement" class="section level3">
<h3 class="hasAnchor">
<a href="#example-expected-quantile-improvement" class="anchor"></a>Example: Expected Quantile Improvement</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/setMBOControlInfill.html">setMBOControlInfill</a></span>(ctrl, <span class="dt">crit =</span> crit.eqi)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/setMBOControlTermination.html">setMBOControlTermination</a></span>(ctrl, <span class="dt">iters =</span> <span class="dv">7</span>)</a></code></pre></div>
<p>For simplification we will let MBO automatically decide for the regression method and the initial design. As the parameter space is purely numeric MBO will use Kriging, which is exactly what we want.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Kriging can create a lot of console output, which we want tu surpress here:</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">configureMlr</span>(<span class="dt">on.learner.warning =</span> <span class="st">"quiet"</span>, <span class="dt">show.learner.output =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">res =<span class="st"> </span><span class="kw"><a href="../../reference/mbo.html">mbo</a></span>(obj.fun, <span class="dt">control =</span> ctrl, <span class="dt">show.info =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">res<span class="op">$</span>x</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">## $x</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">## [1] 0.341864</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">res<span class="op">$</span>y</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">## [1] -1.478403</a></code></pre></div>
<p>As you can see the optimization got fairly close to the minimum at <span class="math inline">\(x = 0\)</span> even though the noise in this area is pretty high.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">(<span class="dt">final.y =</span> <span class="kw">getOptPathY</span>(res<span class="op">$</span>opt.path, <span class="dt">dob =</span> <span class="dv">8</span>))</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">##  [1] -0.2550355 -1.6432325 -1.9874367 -3.9195190 -4.2880125 -3.3275043</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">##  [7] -1.3578305  1.7224402  2.6172207 -2.3451210</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(final.y)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">## [1] 5.204479</a></code></pre></div>
</div>
<div id="example-augmented-expected-improvement" class="section level3">
<h3 class="hasAnchor">
<a href="#example-augmented-expected-improvement" class="anchor"></a>Example: Augmented Expected Improvement</h3>
<p>We can conduct the same optimization using the aei criterion. This time we will make use of <code>exampleRun</code> to visualize the optimization.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">ctrl =<span class="st"> </span><span class="kw"><a href="../../reference/setMBOControlInfill.html">setMBOControlInfill</a></span>(ctrl, <span class="dt">crit =</span> crit.aei)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># Kriging can create a lot of console output, which we want tu surpress here:</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw">configureMlr</span>(<span class="dt">on.learner.warning =</span> <span class="st">"quiet"</span>, <span class="dt">show.learner.output =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">res =<span class="st"> </span><span class="kw"><a href="../../reference/exampleRun.html">exampleRun</a></span>(obj.fun, <span class="dt">control =</span> ctrl, <span class="dt">show.info =</span> <span class="ot">FALSE</span>, <span class="dt">points.per.dim =</span> <span class="dv">200</span>, <span class="dt">noisy.evals =</span> <span class="dv">1</span>)</a></code></pre></div>
<p>First we have a look at the optimization result which is similar to the one obtained with the <code>eqi</code>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">res<span class="op">$</span>mbo.res<span class="op">$</span>x</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">## $x</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">## [1] 0.7137126</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">res<span class="op">$</span>mbo.res<span class="op">$</span>y</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">## [1] 1.582744</a></code></pre></div>
<p>Looking at the surrogate fit during the run we can see that the noise makes it difficult for the Kriging to find the right fit and so it falls back to the mean regression. This leads to the infill criterion to be constant and to a purely random proposal, which is not necessarily that bad as long as it does not happen too often.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="../../reference/plotExampleRun.html">plotExampleRun</a></span>(res, <span class="dt">pause =</span> <span class="ot">FALSE</span>, <span class="dt">iters =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">7</span>))</a></code></pre></div>
<p><img src="noisy_optimization_files/figure-html/unnamed-chunk-1-1.png" width="700"><img src="noisy_optimization_files/figure-html/unnamed-chunk-1-2.png" width="700"><img src="noisy_optimization_files/figure-html/unnamed-chunk-1-3.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#purpose">Purpose</a></li>
      <li><a href="#infill-criteria-for-noisy-optimization">Infill criteria for noisy optimization</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bernd Bischl, Jakob Richter, Jakob Bossek, Daniel Horn, Michel Lang, Janek Thomas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.2.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
